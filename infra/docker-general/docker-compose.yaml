# ═══════════════════════════════════════════════════════════════════════════════
# OurBlock Edge Node - Docker Compose Configuration
# 
# This compose file sets up the complete OurBlock neighborhood node including:
#   - OurBlock Conductor: Runs the Holochain hApp
#   - Lair Keystore: Manages cryptographic keys securely
#   - Bootstrap Service: Local Kitsune2 for offline-mesh resilience (optional)
#   - UI Server: Serves the web interface (optional)
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f ourblock   # View logs
#   docker compose down               # Stop all services
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Lair Keystore - Cryptographic Key Management
  # ─────────────────────────────────────────────────────────────────────────────
  lair-keystore:
    image: holochain/lair-keystore:0.5
    container_name: ourblock-lair
    restart: unless-stopped
    volumes:
      - lair_data:/lair
    environment:
      - LAIR_DIR=/lair
      - LAIR_PASSPHRASE_FILE=/lair/.passphrase
    networks:
      - ourblock-network
    healthcheck:
      test: ["CMD", "lair-keystore", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ─────────────────────────────────────────────────────────────────────────────
  # OurBlock Conductor - Main Holochain Node
  # ─────────────────────────────────────────────────────────────────────────────
  ourblock:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    image: ourblock/edge-node:latest
    container_name: ourblock-conductor
    restart: unless-stopped
    depends_on:
      lair-keystore:
        condition: service_healthy
    ports:
      # Admin interface (internal use only in production)
      - "8001:8001"
      # App WebSocket interface for UI connections
      - "8888:8888"
    volumes:
      - conductor_data:/data
      - conductor_config:/config
      - happ_data:/happs
    environment:
      - RUST_LOG=info
      - HOLOCHAIN_ADMIN_PORT=8001
      - HOLOCHAIN_APP_PORT=8888
      - LAIR_KEYSTORE_URL=lair://lair-keystore:50000
      - BOOTSTRAP_URL=${BOOTSTRAP_URL:-https://bootstrap.holo.host}
      - SIGNAL_URL=${SIGNAL_URL:-wss://signal.holo.host}
      # Network configuration
      - NETWORK_SEED=${NETWORK_SEED:-ourblock-neighborhood-001}
    networks:
      - ourblock-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ─────────────────────────────────────────────────────────────────────────────
  # UI Server - Serves the OurBlock Web Interface
  # ─────────────────────────────────────────────────────────────────────────────
  ui:
    image: nginx:alpine
    container_name: ourblock-ui
    restart: unless-stopped
    depends_on:
      ourblock:
        condition: service_healthy
    ports:
      - "3000:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ui_static:/usr/share/nginx/html:ro
    networks:
      - ourblock-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ─────────────────────────────────────────────────────────────────────────────
  # Socket Proxy - Docker API Security Layer
  # Filters Docker socket access to only allow container restarts
  # ─────────────────────────────────────────────────────────────────────────────
  socket-proxy:
    image: lscr.io/linuxserver/socket-proxy:latest
    container_name: ourblock-socket-proxy
    restart: unless-stopped
    volumes:
      # Mount Docker socket as read-only
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Disable all Docker API endpoints by default
      - CONTAINERS=0
      - IMAGES=0
      - INFO=0
      - NETWORKS=0
      - VOLUMES=0
      - POST=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - SECRETS=0
      # Selectively enable only container restart capability
      - ALLOW_RESTARTS=1
      - LOG_LEVEL=info
    networks:
      - secure-admin-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2375"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    # No ports exposed to host - internal only

  # ─────────────────────────────────────────────────────────────────────────────
  # HTTPS Reverse Proxy - Localhost-Only Gateway
  # Provides HTTPS termination and restricts access to 127.0.0.1 only
  # ─────────────────────────────────────────────────────────────────────────────
  nginx:
    build:
      context: ../infra/nginx
      dockerfile: Dockerfile
    image: ourblock/nginx-proxy:latest
    container_name: ourblock-nginx-proxy
    restart: unless-stopped
    depends_on:
      - sidecar
    ports:
      # Bind to all interfaces (for Docker Desktop compatibility)
      # In production, use: "127.0.0.1:4443:443" for localhost-only access
      - "4443:443"
      - "8080:80"
    volumes:
      # Configuration and logs
      - ../infra/nginx/sidecar.conf:/etc/nginx/conf.d/default.conf:ro
      - ../infra/nginx/certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    networks:
      - secure-admin-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Maintenance Sidecar - System Update Manager (Rust)
  # Manages Docker container updates from within the app
  # ─────────────────────────────────────────────────────────────────────────────
  sidecar:
    build:
      context: ../infra/sidecar
      dockerfile: Dockerfile
    image: ourblock/sidecar:latest
    container_name: ourblock-sidecar
    restart: unless-stopped
    depends_on:
      - socket-proxy
    # Temporarily expose port for testing on Windows (remove in production)
    ports:
      - "3001:3001"
    volumes:
      # Mount docker-compose.yml for updates
      - ./docker-compose.yaml:/app/docker-compose.yaml:ro
    environment:
      - PORT=3001
      - DOCKER_COMPOSE_FILE=/app/docker-compose.yaml
      - APP_VERSION=0.1.0
      # Socket proxy connection
      - DOCKER_HOST=tcp://socket-proxy:2375
      # Admin API key for authentication
      - ADMIN_API_KEY=${ADMIN_API_KEY:-change-me-in-production}
      - RUST_LOG=info
    networks:
      - secure-admin-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Backup Service - Automated Encrypted Backups
  # Runs daily at 3 AM, creates encrypted backups of all Holochain data
  # ─────────────────────────────────────────────────────────────────────────────
  backup:
    build:
      context: ../infra/backup
      dockerfile: Dockerfile
    image: ourblock/backup:latest
    container_name: ourblock-backup
    restart: unless-stopped
    depends_on:
      - ourblock
      - socket-proxy
    volumes:
      # Mount data directories as read-only
      - conductor_data:/storage:ro
      - lair_data:/lair:ro
      - conductor_config:/config:ro
      # Backup output directory
      - backup_data:/backups
      # Docker socket access via proxy (for conductor pause/resume)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Encryption key (from .env file)
      - ADMIN_API_KEY=${ADMIN_API_KEY}
      # Backup retention policy
      - RETENTION_DAYS=30
      # Logging
      - LOG_LEVEL=info
    networks:
      - ourblock-network
      - secure-admin-net
    healthcheck:
      test: ["CMD", "test", "-f", "/backups/latest-backup.tar.gz.enc"]
      interval: 24h
      timeout: 30s
      retries: 3
      start_period: 1h
    # Limit resources to avoid impacting conductor
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ─────────────────────────────────────────────────────────────────────────────
  # Status Dashboard - Node Monitoring Web UI
  # ─────────────────────────────────────────────────────────────────────────────
  status:
    build:
      context: ./status-dashboard
      dockerfile: Dockerfile
    image: ourblock/status-dashboard:latest
    container_name: ourblock-status
    restart: unless-stopped
    depends_on:
      - ourblock
    ports:
      - "${STATUS_PORT:-8080}:8080"
    volumes:
      - conductor_data:/data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - NEIGHBORHOOD_ID=${NETWORK_SEED:-ourblock-neighborhood-001}
      - CONDUCTOR_URL=http://ourblock:8001
      - DATA_DIR=/data
    networks:
      - ourblock-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Avahi/mDNS - Zero-Configuration Network Discovery
  # Enables ourblock.local hostname on local network
  # ─────────────────────────────────────────────────────────────────────────────
  avahi:
    image: flungo/avahi:latest
    container_name: ourblock-avahi
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./avahi:/etc/avahi/services:ro
    environment:
      - AVAHI_HOSTNAME=ourblock
    profiles:
      - mdns

  # ─────────────────────────────────────────────────────────────────────────────
  # Bootstrap Service - Local Kitsune2 for Offline Mesh (Optional)
  # Uncomment to run your own bootstrap/signal server
  # ─────────────────────────────────────────────────────────────────────────────
  # bootstrap:
  #   image: holochain/kitsune2-bootstrap:latest
  #   container_name: ourblock-bootstrap
  #   restart: unless-stopped
  #   ports:
  #     - "8787:8787"
  #   volumes:
  #     - bootstrap_data:/data
  #   environment:
  #     - RUST_LOG=info
  #     - BIND_ADDR=0.0.0.0:8787
  #   networks:
  #     - ourblock-network
  #   profiles:
  #     - mesh

  # ─────────────────────────────────────────────────────────────────────────────
  # Signal Service - WebRTC Signaling for Peer Discovery (Optional)
  # Uncomment for fully offline mesh network
  # ─────────────────────────────────────────────────────────────────────────────
  # signal:
  #   image: holochain/kitsune2-signal:latest
  #   container_name: ourblock-signal
  #   restart: unless-stopped
  #   ports:
  #     - "8989:8989"
  #   volumes:
  #     - signal_data:/data
  #   environment:
  #     - RUST_LOG=info
  #     - BIND_ADDR=0.0.0.0:8989
  #   networks:
  #     - ourblock-network
  #   profiles:
  #     - mesh

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────
networks:
  ourblock-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  
  # Internal network for secure admin operations
  secure-admin-net:
    driver: bridge
    internal: true  # No external access
    ipam:
      config:
        - subnet: 172.29.0.0/16

# ─────────────────────────────────────────────────────────────────────────────
# Volumes - Persistent Data Storage
# ─────────────────────────────────────────────────────────────────────────────
volumes:
  # Lair keystore data (keys, encrypted secrets)
  lair_data:
    driver: local
  
  # Holochain conductor data (DHT, source chain)
  conductor_data:
    driver: local
  
  # Conductor configuration
  conductor_config:
    driver: local
  
  # hApp bundles
  happ_data:
    driver: local
  
  # Static UI files
  ui_static:
    driver: local
  
  # Bootstrap service data (optional)
  # bootstrap_data:
  #   driver: local
  
  # Signal service data (optional)
  # signal_data:
  #   driver: local
  
  # Nginx logs
  nginx-logs:
    driver: local
  
  # Automated backup storage (encrypted)
  backup_data:
    driver: local
