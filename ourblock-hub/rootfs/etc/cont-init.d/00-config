#!/usr/bin/with-contenv bashio
bashio::log.info "Configuring OurBlock..."

# Paths
export CONDUCTOR_CONFIG="/data/conductor-config.yaml"
export LAIR_DIR="/data/lair"
export HAPP_PATH="/usr/local/share/our_block.happ"

# Environment Variables for Conductor
export BOOTSTRAP_URL="https://bootstrap.holo.host"
export SIGNAL_URL="wss://signal.holo.host"
export LAIR_KEYSTORE_URL="unix://${LAIR_DIR}/socket"

mkdir -p "$LAIR_DIR" /data/holochain

# Substitute variables
envsubst < /templates/conductor-config.yaml > "$CONDUCTOR_CONFIG"

# Append App Interface (Port 8888) to Config
cat <<EOF >> "$CONDUCTOR_CONFIG"

app_interfaces:
  - driver:
      type: websocket
      port: 8888
      allowed_origins: "*"
EOF

if ! bashio::fs.file_exists "/data/.installed"; then
    bashio::log.info "Performing first-time app installation..."
    
    # Start Lair temporarily
    bashio::log.info "Starting temp Lair..."
    lair-keystore -d "$LAIR_DIR" &
    LAIR_PID=$!
    sleep 5
    
    # Start Conductor temporarily
    bashio::log.info "Starting temp Conductor..."
    holochain -c "$CONDUCTOR_CONFIG" &
    HC_PID=$!
    
    # Wait for Admin Interface
    bashio::log.info "Waiting for Conductor Admin..."
    for i in $(seq 1 30); do
        if nc -z localhost 8001; then
            break
        fi
        sleep 1
    done
    
    # Install App
    bashio::log.info "Installing App..."
    if hc app install "$HAPP_PATH" --agent-key-id default --app-id ourblock; then
        bashio::log.info "App Installed Successfully!"
        touch "/data/.installed"
    else
        bashio::log.error "App Installation Failed"
    fi
    
    kill $HC_PID 2>/dev/null || true
    kill $LAIR_PID 2>/dev/null || true
    wait $HC_PID 2>/dev/null || true
fi
